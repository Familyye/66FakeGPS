package com.carlex.drive;

import android.location.Location;
import android.location.GnssStatus;
import java.util.Random;

public class NmeaGenerator {
    private Location location;
    private GnssStatus gnssStatus;

    public NmeaGenerator(Location location, GnssStatus gnssStatus) {
        this.location = location;
        this.gnssStatus = gnssStatus;
    }

    public String generateNmeaMessage() {
        StringBuilder nmeaMessage = new StringBuilder();

        // GPGGA sentence
        nmeaMessage.append(generateGPGGA());

        // GPGSA sentence
        //nmeaMessage.append(generateGPGSA());

        // GPGSV sentences (one or more, depending on number of satellites)
        //nmeaMessage.append(generateGPGSV());

        return nmeaMessage.toString();
    }

    private String generateGPGGA() {
        StringBuilder nmeaMessage = new StringBuilder();
        nmeaMessage.append("$GPGGA,");
        nmeaMessage.append(System.currentTimeMillis()).append(",");
        nmeaMessage.append(String.format("%.6f", location.getLatitude())).append(",");
        nmeaMessage.append(location.getLatitude() >= 0 ? "N," : "S,");
        nmeaMessage.append(String.format("%.6f", location.getLongitude())).append(",");
        nmeaMessage.append(location.getLongitude() >= 0 ? "E," : "W,");
        nmeaMessage.append("1,"); // Fix quality
        nmeaMessage.append("04,"); // Number of satellites
        nmeaMessage.append("1.0,"); // HDOP
        nmeaMessage.append(String.format("%.1f", location.getAltitude())).append(",");
        nmeaMessage.append("M,"); // Altitude units
        nmeaMessage.append("-").append(String.format("%.1f", location.getAltitude() + 30.0)); // Altitude above mean sea level
        nmeaMessage.append(","); // Geoid separation
        nmeaMessage.append("0,0"); // Age of differential GPS data and reference station ID
        nmeaMessage.append("*"); // Checksum
        nmeaMessage.append(getChecksum(nmeaMessage.toString()));
        nmeaMessage.append("\r\n");

        return nmeaMessage.toString();
    }

    private String generateGPGSA() {
        StringBuilder nmeaMessage = new StringBuilder();
        nmeaMessage.append("$GPGSA,");
        nmeaMessage.append("A,"); // Mode
        nmeaMessage.append("3,"); // Fix type
        nmeaMessage.append("04,"); // PRN numbers of satellites used for fix
        nmeaMessage.append("1.0,"); // PDOP
        nmeaMessage.append("1.0,"); // HDOP
        nmeaMessage.append("1.0"); // VDOP
        nmeaMessage.append("*"); // Checksum
        nmeaMessage.append(getChecksum(nmeaMessage.toString()));
        nmeaMessage.append("\r\n");

        return nmeaMessage.toString();
    }

    private String generateGPGSV() {
        StringBuilder nmeaMessage = new StringBuilder();
	if (gnssStatus == null) {
		return null;
	}
        for (int i = 0; i < gnssStatus.getSatelliteCount(); i++) {
            nmeaMessage.append("$GPGSV,");
            nmeaMessage.append(gnssStatus.getSatelliteCount()).append(","); // Number of messages
            nmeaMessage.append(i + 1).append(","); // Message number
            nmeaMessage.append(gnssStatus.getSatelliteCount()).append(","); // Satellites in view
            nmeaMessage.append(gnssStatus.getSvid(i)).append(","); // Satellite PRN number
            nmeaMessage.append(gnssStatus.getCn0DbHz(i)).append(","); // Signal-to-noise ratio
            nmeaMessage.append(gnssStatus.getElevationDegrees(i)).append(","); // Elevation in degrees
            nmeaMessage.append(gnssStatus.getAzimuthDegrees(i)).append(","); // Azimuth in degrees
            nmeaMessage.append("0,0"); // SNR, elevation, and azimuth for next satellite
            nmeaMessage.append("*"); // Checksum
            nmeaMessage.append(getChecksum(nmeaMessage.toString()));
            nmeaMessage.append("\r\n");
        }

        return nmeaMessage.toString();
    }

    private int getChecksum(String sentence) {
        int checksum = 0;
        for (int i = 0; i < sentence.length(); i++) {
            checksum ^= sentence.charAt(i);
        }
        return checksum;
    }

    /*
    public static void main(String[] args) {
        // Example usage
        Location location = new Location("gps");
        location.setLatitude(37.7749);
        location.setLongitude(-122.4194);
        GnssStatus gnssStatus = new GnssStatus.Builder().build();
        NmeaGenerator nmeaGenerator = new NmeaGenerator(location, gnssStatus);
        String nmeaMessage = nmeaGenerator.generateNmeaMessage();
        System.out.println(nmeaMessage);
    }*/

}
